<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址 - Lucas's Blog</title><meta name=author content="Lucas"><meta name=description content="介绍如何用 YubiKey FIDO2 的 PRF 扩展派生密钥(KEK),用以 AES-GCM 加密本地私钥,并用一个轻量 keystore 管理以太坊地址.包含设计原理/安全性讨论与使用指南."><meta name=keywords content='YubiKey,fido,private,冷钱包,coldwallet'><meta itemprop=name content="基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址"><meta itemprop=description content="介绍如何用 YubiKey FIDO2 的 PRF 扩展派生密钥(KEK),用以 AES-GCM 加密本地私钥,并用一个轻量 keystore 管理以太坊地址.包含设计原理/安全性讨论与使用指南."><meta itemprop=datePublished content="2025-10-20T00:00:00+08:00"><meta itemprop=dateModified content="2025-10-20T00:00:00+08:00"><meta itemprop=wordCount content="3799"><meta itemprop=keywords content="YubiKey,fido,private,冷钱包,coldwallet"><meta property="og:url" content="https://www.lucas6.xyz/posts/yubikey-coldwallet-fido-private/"><meta property="og:site_name" content="Lucas's Blog"><meta property="og:title" content="基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址"><meta property="og:description" content="介绍如何用 YubiKey FIDO2 的 PRF 扩展派生密钥(KEK),用以 AES-GCM 加密本地私钥,并用一个轻量 keystore 管理以太坊地址.包含设计原理/安全性讨论与使用指南."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-20T00:00:00+08:00"><meta property="article:modified_time" content="2025-10-20T00:00:00+08:00"><meta property="article:tag" content="YubiKey"><meta property="article:tag" content="Coldwallet"><meta property="article:tag" content="Hardware Wallet"><meta property="article:tag" content="FIDO2"><meta property="article:tag" content="Ethereum"><meta property="article:tag" content="Security"><meta name=twitter:card content="summary"><meta name=twitter:title content="基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址"><meta name=twitter:description content="介绍如何用 YubiKey FIDO2 的 PRF 扩展派生密钥(KEK),用以 AES-GCM 加密本地私钥,并用一个轻量 keystore 管理以太坊地址.包含设计原理/安全性讨论与使用指南."><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/images/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://www.lucas6.xyz/posts/yubikey-coldwallet-fido-private/ title="基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址 - Lucas's Blog"><link rel=prev type=text/html href=https://www.lucas6.xyz/posts/huobi-info-withdrawal-guide/ title="原火币(Huobi Global)资金提取完整指南"><link rel=next type=text/html href=https://www.lucas6.xyz/crypto/crypto/test-article/ title="Test Article"><link rel=alternate type=text/markdown href=https://www.lucas6.xyz/posts/yubikey-coldwallet-fido-private/index.md title="基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址 - Lucas's Blog"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.lucas6.xyz\/posts\/yubikey-coldwallet-fido-private\/"},"genre":"posts","keywords":"YubiKey, coldwallet, hardware wallet, FIDO2, Ethereum, security","wordcount":3799,"url":"https:\/\/www.lucas6.xyz\/posts\/yubikey-coldwallet-fido-private\/","datePublished":"2025-10-20T00:00:00+08:00","dateModified":"2025-10-20T00:00:00+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Lucas"},"description":"介绍如何用 YubiKey FIDO2 的 PRF 扩展派生密钥(KEK),用以 AES-GCM 加密本地私钥,并用一个轻量 keystore 管理以太坊地址.包含设计原理/安全性讨论与使用指南."}</script><script src=/js/head/color-scheme.min.js></script><link rel=preload href=/lib/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/lib/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/override.css media=print onload='this.media="all"'><noscript><link rel=stylesheet href=/css/override.css></noscript></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lucas's Blog"><span class=header-title-text>Lucas's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/crypto/><i class="fa-solid fa-key fa-fw fa-sm" aria-hidden=true></i> Crypto</a></li><li class=menu-item><a class=menu-link href=/blockchain/><i class="fa-solid fa-link fa-fw fa-sm" aria-hidden=true></i> Blockchain</a></li><li class=menu-item><a class=menu-link href=/archives/ title=查看历史文章归档><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/categories/ title=查看文章分类><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=/about><i class='fas fa-user'></i> about</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lucas's Blog"><span class=header-title-text>Lucas's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/crypto/><i class="fa-solid fa-key fa-fw fa-sm" aria-hidden=true></i> Crypto</a></li><li class=menu-item><a class=menu-link href=/blockchain/><i class="fa-solid fa-link fa-fw fa-sm" aria-hidden=true></i> Blockchain</a></li><li class=menu-item><a class=menu-link href=/archives/ title=查看历史文章归档><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/categories/ title=查看文章分类><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=/about><i class='fas fa-user'></i> about</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://www.lucas6.xyz title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src=/images/favicon.svg alt=Lucas height=16 width=16>&nbsp;Lucas</a></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/coldwallet/ class=post-category title="分类 - Coldwallet"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Coldwallet</a>&ensp;<a href=/categories/ethereum/ class=post-category title="分类 - Ethereum"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Ethereum</a></span></div><div class=post-meta-line><span title="发布于 2025-10-20 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2025-10-20>2025-10-20</time></span>&nbsp;<span title="3799 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3800 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 8 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#本文说明代码的设计逻辑关键安全考量使用方法与示例并提供源码链接与可下载的示例-keystore-结构说明>本文说明代码的设计逻辑/关键安全考量/使用方法与示例,并提供源码链接与可下载的示例 keystore 结构说明.</a><ul><li><ul><li><a href=#该文使用的所有代码都是试验性的并未得到验证这里只是提供一个思路和方法不可以此作为生产环境>该文使用的所有代码都是试验性的,并未得到验证,这里只是提供一个思路和方法,不可以此作为生产环境.</a></li></ul></li></ul></li><li><a href=#相关源码>相关源码</a></li><li><a href=#背景与目标>背景与目标</a></li><li><a href=#核心设计与代码架构>核心设计与代码架构</a></li><li><a href=#安全与实用性说明>安全与实用性说明</a><ul><li><a href=#使用-yubikey-prf-的动机>使用 YubiKey PRF 的动机</a></li><li><a href=#使用独立-salt_prf-的原因>使用独立 <code>salt_prf</code> 的原因</a></li><li><a href=#为什么依旧用-hkdf-sha256>为什么依旧用 HKDF-SHA256</a></li><li><a href=#aes-gcm-的-aad认证附加数据>AES-GCM 的 AAD(认证附加数据)</a></li><li><a href=#本地文件最小化存储>本地文件最小化存储</a></li></ul></li><li><a href=#使用说明快速示例>使用说明(快速示例)</a></li><li><a href=#keystore-格式说明示例>Keystore 格式说明(示例)</a></li><li><a href=#安全性讨论威胁模型与防护>安全性讨论(威胁模型与防护)</a><ul><li><a href=#假设的威胁模型>假设的威胁模型</a></li><li><a href=#风险与减缓措施>风险与减缓措施</a></li></ul></li><li><a href=#代码关键点实现注意事项>代码关键点(实现注意事项)</a></li><li><a href=#常见问题>常见问题</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><p>本篇文章以实用与工程实现为主,介绍一个基于 YubiKey(FIDO2)PRF 扩展的本地冷钱包思路：<br>使用 YubiKey 在用户触控与 PIN 验证后对<strong>每条私钥</strong>计算一次 PRF(salt),再用 HKDF-SHA256 将 PRF 输出扩展为对称密钥(KEK),以 AES-256-GCM 加密私钥并把最小必要的元数据 (rp_id/credential_id/salt_prf/iv/ciphertext/address 等) 写入本地 <code>privkey_keystore.json</code>.后续解密需要同一 YubiKey/同一 RP ID 与同一 credential_id,并在用户同意触控/输入 PIN 后复现 KEK 解密出私钥.</p><h2 class=heading-element id=本文说明代码的设计逻辑关键安全考量使用方法与示例并提供源码链接与可下载的示例-keystore-结构说明><span>本文说明代码的设计逻辑/关键安全考量/使用方法与示例,并提供源码链接与可下载的示例 keystore 结构说明.</span>
<a href=#%e6%9c%ac%e6%96%87%e8%af%b4%e6%98%8e%e4%bb%a3%e7%a0%81%e7%9a%84%e8%ae%be%e8%ae%a1%e9%80%bb%e8%be%91%e5%85%b3%e9%94%ae%e5%ae%89%e5%85%a8%e8%80%83%e9%87%8f%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95%e4%b8%8e%e7%a4%ba%e4%be%8b%e5%b9%b6%e6%8f%90%e4%be%9b%e6%ba%90%e7%a0%81%e9%93%be%e6%8e%a5%e4%b8%8e%e5%8f%af%e4%b8%8b%e8%bd%bd%e7%9a%84%e7%a4%ba%e4%be%8b-keystore-%e7%bb%93%e6%9e%84%e8%af%b4%e6%98%8e class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h4 class=heading-element id=该文使用的所有代码都是试验性的并未得到验证这里只是提供一个思路和方法不可以此作为生产环境><span>该文使用的所有代码都是试验性的,并未得到验证,这里只是提供一个思路和方法,不可以此作为生产环境.</span>
<a href=#%e8%af%a5%e6%96%87%e4%bd%bf%e7%94%a8%e7%9a%84%e6%89%80%e6%9c%89%e4%bb%a3%e7%a0%81%e9%83%bd%e6%98%af%e8%af%95%e9%aa%8c%e6%80%a7%e7%9a%84%e5%b9%b6%e6%9c%aa%e5%be%97%e5%88%b0%e9%aa%8c%e8%af%81%e8%bf%99%e9%87%8c%e5%8f%aa%e6%98%af%e6%8f%90%e4%be%9b%e4%b8%80%e4%b8%aa%e6%80%9d%e8%b7%af%e5%92%8c%e6%96%b9%e6%b3%95%e4%b8%8d%e5%8f%af%e4%bb%a5%e6%ad%a4%e4%bd%9c%e4%b8%ba%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h2 class=heading-element id=相关源码><span>相关源码</span>
<a href=#%e7%9b%b8%e5%85%b3%e6%ba%90%e7%a0%81 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><ul><li><p><code>fido2_kek.py</code>(派生 KEK / 与 YubiKey 交互):<br><a href=https://github.com/lucas556/yubikey-wallet/blob/main/fido2_kek.py target=_blank rel="external nofollow noopener noreferrer">https://github.com/lucas556/yubikey-wallet/blob/main/fido2_kek.py</a></p></li><li><p><code>seed_keystore.py</code>(早期的 seed keystore 实现,供对比):<br><a href=https://github.com/lucas556/yubikey-wallet/blob/main/seed_keystore.py target=_blank rel="external nofollow noopener noreferrer">https://github.com/lucas556/yubikey-wallet/blob/main/seed_keystore.py</a></p></li></ul><p>建议查看上面两个文件以理解完整细节与历史演进.</p><hr><h2 class=heading-element id=背景与目标><span>背景与目标</span>
<a href=#%e8%83%8c%e6%99%af%e4%b8%8e%e7%9b%ae%e6%a0%87 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>目标是实现一个<strong>离线/本地</strong>/私钥不可导出的冷钱包工作流,其中：</p><ul><li>所有私钥以加密形式保存在本地(JSON keystore),当需要生成链上签名(或导出私钥)时,必须有 YubiKey 的物理接触与 PIN(如果启用).</li><li>使用 FIDO2 的 PRF(HMAC-like)扩展作为“不可提取”的硬件辅助秘密：设备内的凭证私钥与设备固件配合,基于提供的 salt 返回 32 字节 PRF 输出.该输出再经 HKDF-SHA256 得到 KEK,用于对称加密.</li><li>每个条目(entry)使用独立的随机 <code>salt_prf</code>,避免不同私钥间 KEK 重用;加密采用 AES-256-GCM,带 AAD(包含 rp_id)防止混淆上下文.</li></ul><p>设计目标要点：</p><ol><li><strong>最小化本地攻击面</strong>：本地文件仅包含 ciphertext/iv/salt_prf/credential_id 与 rp_id.没有私钥明文,也不存储 KEK.</li><li><strong>物理控制</strong>：解密需要 YubiKey 的存在/用户触控(或其他用户验证),并可能需要 PIN.</li><li><strong>可扩展</strong>：一个 credential_id 可以保护多个私钥(每个私钥独立 salt);entry 格式简单,便于导入/导出/迁移.</li><li><strong>本地离线友好</strong>：RP 校验在实现中采用宽松模式以便本地实验(<code>rp_id</code> 明确记录在 keystore 中),生产请使用真实域名并移除“宽松校验”.</li></ol><hr><h2 class=heading-element id=核心设计与代码架构><span>核心设计与代码架构</span>
<a href=#%e6%a0%b8%e5%bf%83%e8%ae%be%e8%ae%a1%e4%b8%8e%e4%bb%a3%e7%a0%81%e6%9e%b6%e6%9e%84 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>主要模块/职责如下：</p><ul><li><code>fido2_kek.py</code>(核心)：封装与 YubiKey 通信的逻辑,提供：<ul><li>注册发现性凭证(discoverable credential).</li><li>调用 FIDO2 PRF 扩展计算 <code>PRF(salt)</code>.</li><li>将 <code>PRF(salt)</code> 用 HKDF-SHA256 扩展为 KEK(长度可定制,默认 32 字节).</li><li>提供高层 <code>get_kek(client, credential_id_hex, info, salt_prf)</code>：若 <code>salt_prf</code> 为 <code>None</code>,生成随机 salt 并返回 <code>(kek, salt_prf)</code>;若给定 salt,会复现同一 KEK.</li></ul></li><li><code>privkey_keystore.json</code>(本地 keystore)：保存 <code>rp_id</code>/<code>kdf</code>/<code>kdfparams</code>/以及 <code>entries</code> 数组.每条 entry 包含 <code>id</code>/<code>address</code>/<code>salt_prf</code>/<code>crypto</code>(cipher/iv/ciphertext).</li><li><code>cli</code>(交互脚本)：用于生成私钥/调用 YubiKey 得到 KEK/AES-GCM 加密私钥并写入 keystore;以及读取 keystore/调用 YubiKey 得到 KEK 解密私钥.脚本提供三类操作：<ol><li>生成并追加以太坊地址(自动生成 ECDSA/secp256k1 私钥并获得以太坊地址).</li><li>解密某条地址获得私钥(仅在用户触控并验证后).</li><li>创建新的 FIDO2 凭证并打印 <code>rp_id</code> / <code>credential_id</code>(便于备份与记录).</li></ol></li></ul><hr><h2 class=heading-element id=安全与实用性说明><span>安全与实用性说明</span>
<a href=#%e5%ae%89%e5%85%a8%e4%b8%8e%e5%ae%9e%e7%94%a8%e6%80%a7%e8%af%b4%e6%98%8e class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=使用-yubikey-prf-的动机><span>使用 YubiKey PRF 的动机</span>
<a href=#%e4%bd%bf%e7%94%a8-yubikey-prf-%e7%9a%84%e5%8a%a8%e6%9c%ba class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>YubiKey 上的 credential 私钥(用于公钥/签名)不可导出.PRF 扩展允许设备在不暴露私钥的情况下,计算基于设备私钥的 HMAC 型输出 <code>PRF(salt)</code>.利用该输出作为对称密钥的种子可以实现“硬件绑定的 KEK”.</li><li>相较于把设备上的签名私钥直接作为对称密钥(这通常不可行且语义不清),PRF 提供了一个标准化/可重复/可组合的方式来派生对称 KEK,并可以通过 <code>salt</code> 和 <code>info</code> 区分用途.</li></ul><h3 class=heading-element id=使用独立-salt_prf-的原因><span>使用独立 <code>salt_prf</code> 的原因</span>
<a href=#%e4%bd%bf%e7%94%a8%e7%8b%ac%e7%ab%8b-salt_prf-%e7%9a%84%e5%8e%9f%e5%9b%a0 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>若直接对所有私钥使用相同 PRF 输入,得到的 KEK 相同,则一个被解密的私钥即泄露保护其他所有私钥的能力(即<strong>同钥多条</strong>问题).通过对每条私钥使用独立随机 <code>salt_prf</code>,即便使用同一 credential_id,攻击者要解密任意一条,仍需在设备上触控并提供 PIN.</li></ul><h3 class=heading-element id=为什么依旧用-hkdf-sha256><span>为什么依旧用 HKDF-SHA256</span>
<a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%be%9d%e6%97%a7%e7%94%a8-hkdf-sha256 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>PRF 输出是 32 字节“原始”结果,将其直接作为 KEK 是可行的,但使用 HKDF 带来的好处：<ul><li>明确区分用途：<code>info</code> 字段能够在同一 credential 上派生出不同用途的 KEK(例如 <code>privkey-v1</code>/<code>evm-priv-v1</code>),防止不同用途的密钥互相替代或滥用.</li><li>HKDF 提供额外的抗碰撞/拉开用途域(domain separation),是工程实践中的良好做法.</li></ul></li><li>因此流程为：<code>PRF(salt)</code> → HKDF(info) → KEK → AES-256-GCM(IV, AAD)→ ciphertext.</li></ul><h3 class=heading-element id=aes-gcm-的-aad认证附加数据><span>AES-GCM 的 AAD(认证附加数据)</span>
<a href=#aes-gcm-%e7%9a%84-aad%e8%ae%a4%e8%af%81%e9%99%84%e5%8a%a0%e6%95%b0%e6%8d%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>我们把 <code>AAD = b"type=privkey|v=1|rp=&lt;rp_id>"</code> 包含到加密中,这样在解密时会验证 AAD 是否一致,避免将同一 ciphertext 用在不同 RP 或不同用途场景下导致误解密或误用.</li></ul><h3 class=heading-element id=本地文件最小化存储><span>本地文件最小化存储</span>
<a href=#%e6%9c%ac%e5%9c%b0%e6%96%87%e4%bb%b6%e6%9c%80%e5%b0%8f%e5%8c%96%e5%ad%98%e5%82%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li><code>privkey_keystore.json</code> 只保存：<ul><li><code>rp_id</code> 与 <code>credential_id</code>(标识哪把 YubiKey /凭证可解密)</li><li>对每条私钥：<code>salt_prf</code>(用于在设备上复现 PRF)/<code>iv</code>/<code>ciphertext</code>/已派生的 <code>address</code> 以及一个 UUID <code>id</code></li></ul></li><li>不保存 KEK/明文私钥或任何能直接伪造 PRF 的秘密.</li></ul><hr><h2 class=heading-element id=使用说明快速示例><span>使用说明(快速示例)</span>
<a href=#%e4%bd%bf%e7%94%a8%e8%af%b4%e6%98%8e%e5%bf%ab%e9%80%9f%e7%a4%ba%e4%be%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><blockquote><p>假设已安装 Python 依赖并将 YubiKey 插入,且你的 <code>fido2_kek.py</code> 与 CLI 脚本在同一目录.</p></blockquote><ol><li>创建新的凭证并打印(可选)：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>python3 cli.py
</span></span><span class=line><span class=cl># 选择：3) create new fido2 credential and print rp_id / credential_id
</span></span><span class=line><span class=cl># 记录 rp_id 与 credential_id 以便备份</span></span></code></pre></td></tr></table></div></div><ol start=2><li>生成并追加新的以太坊地址(会在本地生成私钥/加密并写入 keystore)：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 选择：1) generate and append new ethereum address
</span></span><span class=line><span class=cl># 输入 keystore 路径(默认 privkey_keystore.json)
</span></span><span class=line><span class=cl># 若文件不存在,会提示输入 rp_id 并在 YubiKey 上创建一个 discoverable credential(需要 PIN/触控)
</span></span><span class=line><span class=cl># 若文件存在,会读取文件中的 rp_id 与 credential_id 并复用(无需新建凭证)
</span></span><span class=line><span class=cl># 脚本会在设备上提示输入 PIN 与触控以派生 KEK(并生成 salt_prf)</span></span></code></pre></td></tr></table></div></div><ol start=3><li>解密某个地址的私钥：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 选择：2) decrypt one address
</span></span><span class=line><span class=cl># 选择要解密的地址序号
</span></span><span class=line><span class=cl># 脚本会向 YubiKey 请求 PRF(salt_prf)(需要 PIN/触控),并在本地用 AES-GCM 解密出私钥</span></span></code></pre></td></tr></table></div></div><p>注意：若键盘或终端提示“Please enter your YubiKey FIDO2 PIN”,请输入 YubiKey 的 FIDO2 PIN(默认可能为空但取决于你的配置).</p><hr><h2 class=heading-element id=keystore-格式说明示例><span>Keystore 格式说明(示例)</span>
<a href=#keystore-%e6%a0%bc%e5%bc%8f%e8%af%b4%e6%98%8e%e7%a4%ba%e4%be%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>最小 keystore JSON(<code>privkey_keystore.json</code>)示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;rp_id&#34;</span><span class=p>:</span> <span class=s2>&#34;wallet.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kdf&#34;</span><span class=p>:</span> <span class=s2>&#34;fido2-prf+hkdf-sha256&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kdfparams&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;rp_id&#34;</span><span class=p>:</span> <span class=s2>&#34;wallet.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;credential_id&#34;</span><span class=p>:</span> <span class=s2>&#34;52f92533242c...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;info&#34;</span><span class=p>:</span> <span class=s2>&#34;privkey-v1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;entries&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;5983c3f2-1a2b-4d4f-9a8d-5b6c7d8e9f00&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;0x8784c4c3e34168Ab3E49dEb74937Cf8F3847dA2d&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;salt_prf&#34;</span><span class=p>:</span> <span class=s2>&#34;b3f1a2... (64 hex chars)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;crypto&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;cipher&#34;</span><span class=p>:</span> <span class=s2>&#34;aes-256-gcm&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;iv&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;24 hex chars&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;ciphertext&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;ciphertext hex&gt;&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>关键点：</p><ul><li><code>credential_id</code>：discoverable credential 的 ID(hex),用于在 YubiKey 上索引对应凭证进行 PRF.</li><li><code>salt_prf</code>：每条 entry 的随机 32 字节(以 hex 存储),在解密时需要把它传给设备以复现 PRF 输出.</li><li><code>iv</code> / <code>ciphertext</code>：AES-GCM 的 IV 与密文.</li><li><code>address</code>：明文保存以便快速展示,避免每次需要解密查看地址.</li></ul><hr><h2 class=heading-element id=安全性讨论威胁模型与防护><span>安全性讨论(威胁模型与防护)</span>
<a href=#%e5%ae%89%e5%85%a8%e6%80%a7%e8%ae%a8%e8%ae%ba%e5%a8%81%e8%83%81%e6%a8%a1%e5%9e%8b%e4%b8%8e%e9%98%b2%e6%8a%a4 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=假设的威胁模型><span>假设的威胁模型</span>
<a href=#%e5%81%87%e8%ae%be%e7%9a%84%e5%a8%81%e8%83%81%e6%a8%a1%e5%9e%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>攻击者可能获得你的硬盘快照或备份(含 <code>privkey_keystore.json</code>).</li><li>攻击者可能短暂接触到你的机器,但<strong>无法</strong>控制或读取 YubiKey(物理隔离).</li><li>攻击者<strong>可能</strong>获得 YubiKey(这意味着严重风险,取决于是否知道 PIN).</li></ul><h3 class=heading-element id=风险与减缓措施><span>风险与减缓措施</span>
<a href=#%e9%a3%8e%e9%99%a9%e4%b8%8e%e5%87%8f%e7%bc%93%e6%8e%aa%e6%96%bd class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ol><li><strong>本地文件被泄露</strong>：文件本身仅包含 ciphertext 与 salt,无法在没有 YubiKey 的情况下解密.攻击者需要同时获得你的 YubiKey 并通过 PIN/触控才能复现 KEK.</li><li><strong>YubiKey 被盗</strong>：若攻击者获得了 YubiKey <strong>且</strong>知道/绕过了 PIN,则可解密所有条目(同一 credential 的所有条目仍需要 salt,但 salt 存储于文件;因此窃取 YubiKey + 凭证 ID + PIN 就能解密).减缓：为 YubiKey 设置 PIN,并考虑用多因素或将凭证分布到多把 YubiKey.</li><li><strong>Side-channel / Host compromise</strong>：若主机被完全控制(恶意驱动或内核级监控),则攻击者能在用户解密时即时拷贝明文私钥或劫持签名流程.减缓：尽量在离线/受信环境中进行敏感操作;使用离线签名策略(在隔离主机或受限环境签名).</li><li><strong>PRF / HKDF 安全</strong>：PRF 由设备实现,理论上等价于 HMAC(K_cred, salt).HKDF 是公认的安全扩展.使用 info 作为用途分离是良好实践.</li><li><strong>Yubikey丢失风险</strong>: <strong>如果硬件丢失,将无法解密,建议备份</strong></li></ol><hr><h2 class=heading-element id=代码关键点实现注意事项><span>代码关键点(实现注意事项)</span>
<a href=#%e4%bb%a3%e7%a0%81%e5%85%b3%e9%94%ae%e7%82%b9%e5%ae%9e%e7%8e%b0%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><ul><li><p>对于 <code>Fido2PRFClient</code>：</p><ul><li>在本地实验中使用了宽松的 CDC(Client Data Collector)以避免 origin/rp 限制;<strong>生产必须删除该宽松策略</strong> 并使用真实 <code>rp_id</code> 与 <code>origin</code>.</li><li>操作需要用户 PIN(若启用)与触控(用户验证).</li><li>处理 PIN 相关的错误与锁定(PIN_AUTH_BLOCKED/PIN_BLOCKED)并友好提示.</li></ul></li><li><p><code>get_kek(...)</code>：</p><ul><li>若 <code>salt_prf</code> 为 <code>None</code>,函数会随机生成一个 32 字节 salt,调用 PRF 并返回 <code>(kek, salt_prf)</code>.</li><li>若 <code>salt_prf</code> 已给定,函数只做 PRF 调用以复现之前的 KEK.</li></ul></li><li><p>AES-GCM：</p><ul><li>IV 使用 12 字节随机值.</li><li>AAD 必须在加密与解密时一致(包含 <code>rp_id</code> 有助于防止跨 RP 混用).</li></ul></li><li><p>错误处理：</p><ul><li>对文件结构/字段类型做轻量校验;解密失败会输出友好错误.</li><li>对 YubiKey/CTAP 错误需明确区分 PIN 错误与其他错误并给出提示信息.</li></ul></li></ul><hr><h2 class=heading-element id=常见问题><span>常见问题</span>
<a href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p><strong>Q: 为什么不直接把设备上的签名私钥用于链上签名？</strong><br>A: 有些 YubiKey 应用(OpenPGP/PIV)支持 secp256k1,因此可以在设备上直接签名链上交易(例如导出公钥用于地址),但在很多平台上 FIDO2/CTAP 的签名语义与区块链签名语义不完全一致;PRF 提供的是对称密钥派生能力,适合把 YubiKey 作为“不可导出密钥”的种子,从而保护本地私钥的加密与解密流程.</p><p><strong>Q: PRF 输出是否可直接作为 AES 的密钥？</strong><br>A: 技术上直接使用 PRF(salt) 的 32 字节作为 AES-256 密钥是可行的,但通过 HKDF 能够添加 <code>info</code> 做用途分离并具备更明确的密钥衍生语义,因此更推荐使用 HKDF.</p><hr><h2 class=heading-element id=总结><span>总结</span>
<a href=#%e6%80%bb%e7%bb%93 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>本文给出了一种利用 YubiKey FIDO2 PRF 扩展为本地私钥加密提供硬件绑定 KEK 的方法,权衡了工程实现与安全性.关键思想是<strong>将不可导出的设备秘钥能力(PRF)作为派生对称密钥的根源</strong>,再结合每条私钥独立 salt/HKDF 用途分离与 AES-GCM 加密,达到“本地存储而不可无凭证解密”的目标.</p><p>本文配套的示例代码实现了 CLI 工具,支持生成凭证/添加以太坊地址并加密私钥/以及在需要时用 YubiKey 解密私钥.若计划用于生产或大规模使用,请务必审计 YubiKey 配置(是否启用 PIN/是否使用真实 rp_id/origin)/审查主机安全与签名流程,并考虑更严格的硬件密钥管理策略(如多重备份/设备轮换等).</p><hr></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2025-10-20 00:00:00">更新于 2025-10-20&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/yubikey-coldwallet-fido-private/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://www.lucas6.xyz/posts/yubikey-coldwallet-fido-private/ data-title="基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址" data-hashtags="YubiKey,coldwallet,hardware wallet,FIDO2,Ethereum,security"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://www.lucas6.xyz/posts/yubikey-coldwallet-fido-private/ data-hashtag=YubiKey><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://www.lucas6.xyz/posts/yubikey-coldwallet-fido-private/ data-title="基于 YubiKey 的冷钱包探索3：使用 FIDO2 派生 KEK 加密私钥并管理以太坊地址"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/yubikey/ class=post-tag title="标签 - YubiKey">YubiKey</a><a href=/tags/coldwallet/ class=post-tag title="标签 - Coldwallet">Coldwallet</a><a href=/tags/hardware-wallet/ class=post-tag title="标签 - Hardware Wallet">Hardware Wallet</a><a href=/tags/fido2/ class=post-tag title="标签 - FIDO2">FIDO2</a><a href=/tags/ethereum/ class=post-tag title="标签 - Ethereum">Ethereum</a><a href=/tags/security/ class=post-tag title="标签 - Security">Security</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/huobi-info-withdrawal-guide/ class=post-nav-item rel=prev title="原火币(Huobi Global)资金提取完整指南"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>原火币(Huobi Global)资金提取完整指南</a><a href=/crypto/crypto/test-article/ class=post-nav-item rel=next title="Test Article">Test Article<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><script>window.addEventListener("load",function(){var e=document.createElement("script");e.src="https://www.lucas6.xyz/plugins/js-sdk-pro.min.js",e.async=!0,e.onload=function(){LA.init({id:"3NHsYi6Mg6jwyr74",ck:"3NHsYi6Mg6jwyr74"})},document.head.appendChild(e)})</script><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2023 - 2026</span><span class=author itemprop=copyrightHolder>
<a href=https://www.lucas6.xyz target=_blank rel="external nofollow noopener noreferrer">Lucas</a></span><span class="license footer-divider"><a href=https://www.lucas6.xyz/copyright/ target=_blank>版权声明 / Copyright</a> | <a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line beian"><span class=gov><a href="https://beian.mps.gov.cn/#/query/webSearch?code=41100002000596" target=_blank rel="nofollow noopener noreferrer">豫公网安备41100002000596号</a></span><span class="icp footer-divider"><a href=https://beian.miit.gov.cn/ target=_blank rel="nofollow noopener noreferrer">豫ICP备2025141250号-1</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},version:"v0.4.0-alpha-20250721024521-a1cd700b"}</script><script src=/js/theme.min.js defer></script></body></html>